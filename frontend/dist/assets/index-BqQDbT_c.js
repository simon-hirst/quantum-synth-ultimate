(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const e of i)if(e.type==="childList")for(const r of e.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const e={};return i.integrity&&(e.integrity=i.integrity),i.referrerPolicy&&(e.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?e.credentials="include":i.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function a(i){if(i.ep)return;i.ep=!0;const e=t(i);fetch(i.href,e)}})();class b{constructor(s,t={}){var a,i;this.opts=t,this.gl=null,this.program=null,this.buffer=null,this.u={},this.textures=[],this.ws=null,this.streamTex=null,this.streamUnit=5,this.streamW=0,this.streamH=0,this.audioCtx=null,this.analyser=null,this.freq=null,this.stream=null,this.env=0,this.envAttack=.25,this.envRelease=.05,this.lastEnergy=0,this.beat=0,this.beatCooldown=0,this.demo=!1,this.anim=null,this.frames=0,this.lastTick=performance.now(),this.vsrc=`
    attribute vec2 aPos;
    varying vec2 vUV;
    void main(){ vUV = aPos*0.5 + 0.5; gl_Position = vec4(aPos,0.0,1.0); }
  `,this.canvas=s,this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas()),window.addEventListener("orientationchange",()=>this.resizeCanvas()),this.gl=s.getContext("webgl2")||s.getContext("webgl"),this.gl||(this.paintFallback(),(i=(a=this.opts).onStatus)==null||i.call(a,"WebGL not supported"))}async start(){await this.loadServerShader("composite"),this.connectStream(),this.loop()}stop(){var s;this.anim&&cancelAnimationFrame(this.anim),this.anim=null,(s=this.ws)==null||s.close()}async startScreenShare(){var i;const s=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:{echoCancellation:!1,noiseSuppression:!1}});if(!s.getAudioTracks().length)throw s.getTracks().forEach(e=>e.stop()),new Error("No audio shared");(i=this.audioCtx)==null||i.close().catch(()=>{}),this.audioCtx=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.audioCtx.createAnalyser(),this.analyser.fftSize=1024,this.audioCtx.createMediaStreamSource(s).connect(this.analyser),this.freq=new Uint8Array(this.analyser.frequencyBinCount),this.stream=s;const a=s.getVideoTracks()[0];a&&(a.onended=()=>this.stopScreenShare())}stopScreenShare(){var s;(s=this.stream)==null||s.getTracks().forEach(t=>t.stop()),this.stream=null,this.freq=null,this.audioCtx&&(this.audioCtx.close().catch(()=>{}),this.audioCtx=null),this.analyser=null}isSharing(){return!!this.stream}setDemoMode(s){this.demo=s,s&&this.stopScreenShare()}async loadServerShader(s){var t,a,i,e,r,c;if(this.gl){(a=(t=this.opts).onStatus)==null||a.call(t,"Fetching shader…");try{const l="/api/shader/next"+(s?`?type=${encodeURIComponent(s)}`:"")+"&ts="+Date.now(),h=await fetch(l,{cache:"no-store"});if(!h.ok)throw new Error("fetch failed: "+h.status);const o=await h.json();await this.buildFromServer(o),(e=(i=this.opts).onStatus)==null||e.call(i,`Loaded: ${o.name}`)}catch{(c=(r=this.opts).onStatus)==null||c.call(r,"Backend unreachable; using local shader"),await this.buildLocal()}}}compile(s,t){const a=this.gl,i=a.createShader(s);if(a.shaderSource(i,t),a.compileShader(i),!a.getShaderParameter(i,a.COMPILE_STATUS)){const e=a.getShaderInfoLog(i);throw a.deleteShader(i),new Error("Shader compile error: "+e)}return i}async buildFromServer(s){const t=this.gl,a=this.compile(t.VERTEX_SHADER,this.vsrc),i=this.compile(t.FRAGMENT_SHADER,s.code),e=t.createProgram();if(t.attachShader(e,a),t.attachShader(e,i),t.linkProgram(e),!t.getProgramParameter(e,t.LINK_STATUS)){console.error("Program link error:",t.getProgramInfoLog(e)),await this.buildLocal();return}this.program=e,this.u={},this.textures=[];const r=new Float32Array([-1,-1,1,-1,-1,1,1,-1,1,1,-1,1]),c=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,c),t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW),this.buffer=c,t.useProgram(this.program);const l=t.getAttribLocation(this.program,"aPos");t.enableVertexAttribArray(l),t.vertexAttribPointer(l,2,t.FLOAT,!1,0,0);for(const o of["uTime","uRes","uLevel","uBands","uPulse","uBeat","uBlendFlow","uBlendRD","uBlendStream","uFrame","uAtlasGrid","uAtlasFrames","uAtlasFPS","uStreamRes"])this.u[o]=t.getUniformLocation(this.program,o);let h=0;if(Array.isArray(s.textures))for(const o of s.textures){const d=t.createTexture();await this.uploadTexture(d,o.dataUrl,h,!0),this.textures.push({name:o.name,tex:d,unit:h,meta:o});const n=t.getUniformLocation(this.program,o.name);n&&t.uniform1i(n,h),h++,o.gridCols&&o.gridRows&&(this.u.uAtlasGrid&&t.uniform2f(this.u.uAtlasGrid,o.gridCols,o.gridRows),this.u.uAtlasFrames&&t.uniform1f(this.u.uAtlasFrames,o.frames??o.gridCols*o.gridRows),this.u.uAtlasFPS&&t.uniform1f(this.u.uAtlasFPS,o.fps??24))}if(this.streamTex){const o=t.getUniformLocation(this.program,"uStreamTex");o&&t.uniform1i(o,this.streamUnit),this.u.uStreamRes&&t.uniform2f(this.u.uStreamRes,this.streamW,this.streamH)}this.resizeCanvas()}async buildLocal(){const s=this.gl,t=this.compile(s.VERTEX_SHADER,this.vsrc),a=this.compile(s.FRAGMENT_SHADER,`
      precision mediump float; varying vec2 vUV; uniform float uTime, uLevel; void main(){
        float t=uTime*.6; vec3 col=vec3(.4+.6*sin(t+(vUV.x+vUV.y)*18.0), .4+.6*sin(t+(vUV.x-vUV.y)*22.0+2.1), .4+.6*sin(t+vUV.y*20.0+4.2))*(.5+1.5*uLevel);
        gl_FragColor=vec4(col,1.0);
      }`),i=s.createProgram();if(s.attachShader(i,t),s.attachShader(i,a),s.linkProgram(i),!s.getProgramParameter(i,s.LINK_STATUS)){console.error("Link error:",s.getProgramInfoLog(i)),this.paintFallback();return}this.program=i,this.u={uTime:s.getUniformLocation(i,"uTime"),uLevel:s.getUniformLocation(i,"uLevel")};const e=new Float32Array([-1,-1,1,-1,-1,1,1,-1,1,1,-1,1]),r=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,r),s.bufferData(s.ARRAY_BUFFER,e,s.STATIC_DRAW),this.buffer=r,s.useProgram(i);const c=s.getAttribLocation(i,"aPos");s.enableVertexAttribArray(c),s.vertexAttribPointer(c,2,s.FLOAT,!1,0,0),this.resizeCanvas()}async uploadTexture(s,t,a,i){const e=this.gl;await new Promise((r,c)=>{const l=new Image;l.onload=()=>{e.activeTexture(e.TEXTURE0+a),e.bindTexture(e.TEXTURE_2D,s),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,l),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);const h=i?e.REPEAT:e.CLAMP_TO_EDGE;e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,h),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,h),r()},l.onerror=()=>c(new Error("texture load failed")),l.src=t})}connectStream(){var t;const s=location.protocol==="https:"?"wss:":"ws:";(t=this.ws)==null||t.close(),this.ws=new WebSocket(`${s}//${location.host}/ws`),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{var a,i,e;(i=(a=this.opts).onStatus)==null||i.call(a,"WS connected (stream)…"),(e=this.ws)==null||e.send(JSON.stringify({type:"subscribe",field:"waves",w:256,h:256,fps:24}))},this.ws.onmessage=a=>{typeof a.data!="string"&&this.onStreamFrame(a.data)},this.ws.onerror=()=>{var a,i;return(i=(a=this.opts).onStatus)==null?void 0:i.call(a,"WS error")},this.ws.onclose=()=>{var a,i;return(i=(a=this.opts).onStatus)==null?void 0:i.call(a,"WS disconnected")}}onStreamFrame(s){const t=this.gl;if(!t)return;const a=new DataView(s,0,24);if(!String.fromCharCode(...new Uint8Array(s.slice(0,8))).startsWith("FRAMEv1"))return;const e=a.getUint32(8,!0),r=a.getUint32(12,!0),c=a.getUint32(16,!0),l=new Uint8Array(s,24);if(c===4)if(!this.streamTex||this.streamW!==e||this.streamH!==r){this.streamTex=t.createTexture(),this.streamW=e,this.streamH=r,t.activeTexture(t.TEXTURE0+this.streamUnit),t.bindTexture(t.TEXTURE_2D,this.streamTex),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,r,0,t.RGBA,t.UNSIGNED_BYTE,l),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT);const h=t.getUniformLocation(this.program,"uStreamTex");h&&t.uniform1i(h,this.streamUnit),this.u.uStreamRes&&t.uniform2f(this.u.uStreamRes,e,r)}else t.activeTexture(t.TEXTURE0+this.streamUnit),t.bindTexture(t.TEXTURE_2D,this.streamTex),t.texSubImage2D(t.TEXTURE_2D,0,0,0,e,r,t.RGBA,t.UNSIGNED_BYTE,l)}loop(){const s=t=>{this.render(t),this.anim=requestAnimationFrame(s)};this.anim=requestAnimationFrame(s)}render(s){var o,d;const t=this.gl;if(!t||!this.program)return;this.frames++,s-this.lastTick>=1e3&&((d=(o=this.opts).onFps)==null||d.call(o,this.frames),this.frames=0,this.lastTick=s);let i=0,e=[0,0,0,0];if(this.analyser&&this.freq){this.analyser.getByteFrequencyData(this.freq);const n=this.freq.length;let f=0;for(let m=0;m<n;m++){const g=this.freq[m]/255;f+=g*g}const u=Math.sqrt(f/n);u>this.env?this.env=this.env+(u-this.env)*this.envAttack:this.env=this.env+(u-this.env)*this.envRelease;const p=u,R=p-this.lastEnergy;this.lastEnergy=p,this.beat=Math.max(0,this.beat-.12),R>.08&&this.beatCooldown<=0&&(this.beat=1,this.beatCooldown=8),this.beatCooldown>0&&this.beatCooldown--;const E=(m,g)=>{let v=0;for(let S=m;S<g;S++)v+=this.freq[S];return v/((g-m)*255)};e[0]=E(0,n/8|0),e[1]=E(n/8|0,n/4|0),e[2]=E(n/4|0,n/2|0),e[3]=E(n/2|0,n),i=this.env}else if(this.demo){const n=s/1e3;e=[(Math.sin(n*1.2)+1)/2,(Math.sin(n*1.7+1)+1)/2,(Math.sin(n*2.3+2)+1)/2,(Math.sin(n*2.9+3)+1)/2],i=(e[0]+e[1]+e[2]+e[3])/4,this.beat=Math.max(0,this.beat-.05),Math.sin(n*2.5)>.995&&(this.beat=1),this.beat>0&&(this.beat-=.06)}t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT),this.u.uTime&&t.uniform1f(this.u.uTime,s/1e3),this.u.uRes&&t.uniform2f(this.u.uRes,this.canvas.width,this.canvas.height),this.u.uLevel&&t.uniform1f(this.u.uLevel,i),this.u.uBands&&t.uniform1fv(this.u.uBands,new Float32Array(e)),this.u.uPulse&&t.uniform1f(this.u.uPulse,Math.max(0,this.env-.5)*2),this.u.uBeat&&t.uniform1f(this.u.uBeat,this.beat);const r=this.textures.find(n=>n.meta&&n.meta.gridCols&&n.meta.gridRows);if(r!=null&&r.meta){const n=r.meta.frames??r.meta.gridCols*r.meta.gridRows,f=r.meta.fps??24,u=Math.floor(s/1e3*f)%Math.max(1,n);this.u.uAtlasGrid&&t.uniform2f(this.u.uAtlasGrid,r.meta.gridCols,r.meta.gridRows),this.u.uAtlasFrames&&t.uniform1f(this.u.uAtlasFrames,n),this.u.uAtlasFPS&&t.uniform1f(this.u.uAtlasFPS,f),this.u.uFrame&&t.uniform1f(this.u.uFrame,u)}const c=.4*(1-Math.min(1,i*1.2))+.15*e[0],l=.4+.6*e[2],h=Math.min(1,.2+1.8*i)+this.beat*.4;this.u.uBlendFlow&&t.uniform1f(this.u.uBlendFlow,c),this.u.uBlendRD&&t.uniform1f(this.u.uBlendRD,l),this.u.uBlendStream&&t.uniform1f(this.u.uBlendStream,h);for(const n of this.textures)t.activeTexture(t.TEXTURE0+n.unit),t.bindTexture(t.TEXTURE_2D,n.tex);this.streamTex&&(t.activeTexture(t.TEXTURE0+this.streamUnit),t.bindTexture(t.TEXTURE_2D,this.streamTex)),t.drawArrays(t.TRIANGLES,0,6)}paintFallback(){const s=this.canvas.getContext("2d");if(!s)return;const t=this.canvas.clientWidth,a=this.canvas.clientHeight,i=s.createLinearGradient(0,0,t,a);i.addColorStop(0,"#0b1020"),i.addColorStop(1,"#000"),s.fillStyle=i,s.fillRect(0,0,t,a),s.fillStyle="#9efcff",s.font="14px system-ui,-apple-system,Segoe UI,Roboto",s.fillText("WebGL unavailable — using fallback",16,28)}resizeCanvas(){var r;const t=(this.canvas.parentElement??document.body).getBoundingClientRect(),a=Math.max(1,Math.floor(t.width)),i=Math.max(1,Math.floor(t.height||0||420)),e=Math.max(1,Math.round(window.devicePixelRatio||1));this.canvas.style.width=`${a}px`,this.canvas.style.height=`${i}px`,(this.canvas.width!==a*e||this.canvas.height!==i*e)&&(this.canvas.width=a*e,this.canvas.height=i*e),(r=this.gl)==null||r.viewport(0,0,this.canvas.width,this.canvas.height)}}document.addEventListener("DOMContentLoaded",async()=>{const T=document.querySelector("#app");if(!T)return;T.innerHTML=`
    <div class="qs-shell">
      <aside class="qs-panel glass">
        <h1 class="qs-title">QuantumSynth</h1>
        <p class="qs-sub">Neural Edition</p>
        <div class="qs-divider"></div>

        <div class="qs-kv">
          <div id="status" class="qs-status">Ready</div>
          <div id="fps" class="qs-fps">FPS: 0</div>
        </div>

        <div class="qs-actions">
          <button id="btnShare" class="btn btn-primary">Start Screen Sharing</button>
          <button id="btnDemo" class="btn btn-ghost">Demo Mode</button>
        </div>

        <h2 class="qs-h2">Setup</h2>
        <ol class="qs-list">
          <li>Use Chrome or Edge for best results</li>
          <li>When prompted, tick <b>“Share audio”</b></li>
          <li>Select the tab/window you want visualised</li>
          <li>Press <b>N</b> to load next server shader</li>
        </ol>

        <div class="qs-footer">
          built by <a href="https://github.com/simon-hirst" target="_blank" rel="noopener">https://github.com/simon-hirst</a>
        </div>
      </aside>

      <main class="qs-stage">
        <canvas id="visualizer" class="qs-canvas"></canvas>
      </main>
    </div>
  `;const s=document.getElementById("visualizer"),t=document.getElementById("status"),a=document.getElementById("fps"),i=document.getElementById("btnShare"),e=document.getElementById("btnDemo");if(!s)return;const r=new b(s,{onStatus:h=>{t.textContent=h},onFps:h=>{a.textContent=`FPS: ${h}`}});await r.start();const c=()=>{i.textContent=r.isSharing()?"Stop Screen Sharing":"Start Screen Sharing"};c(),i.addEventListener("click",async()=>{if(r.isSharing()){r.stopScreenShare(),t.textContent="Screen share stopped",c();return}i.disabled=!0,t.textContent='Requesting screen share (enable "Share audio")…';try{await r.startScreenShare(),t.textContent="Screen sharing active"}catch{t.textContent="Permission denied or no audio shared"}finally{i.disabled=!1,c()}});let l=!1;e.addEventListener("click",()=>{l=!l,r.setDemoMode(l),e.textContent=l?"Stop Demo":"Demo Mode",t.textContent=l?"Demo mode active":"Ready"}),document.addEventListener("keydown",h=>{var o;h.key.toLowerCase()==="n"&&((o=r.loadServerShader)==null||o.call(r))})});
